<template>
  <div class="sticky z-20 top-24 flex justify-between items-center">
    <svg class="h-8 w-auto mb-2 max-w-full text-gray-200 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 858 177">
      <path d="M8.666 174.665c-2.067 0-3.895-.475-5.485-1.427-1.59-1.111-2.385-2.697-2.385-4.76V6.66c0-1.586.557-2.935 1.67-4.045C3.737 1.505 5.406.87 7.473.711h43.879c9.22 0 17.567 1.666 25.04 4.998 7.471 3.331 13.353 8.725 17.646 16.181 4.292 7.298 6.438 17.055 6.438 29.27v2.38c0 12.374-2.225 22.29-6.677 29.746-4.292 7.298-10.254 12.692-17.885 16.182-7.472 3.331-15.818 4.997-25.04 4.997H16.536v64.013c0 2.063-.874 3.649-2.623 4.76-1.59.952-3.339 1.427-5.246 1.427Zm7.87-84.002h34.339c10.651 0 18.918-2.935 24.8-8.805 6.042-6.028 9.063-15.23 9.063-27.604v-2.618c0-12.533-3.021-21.734-9.062-27.604-5.883-5.87-14.15-8.805-24.801-8.805h-34.34v75.436ZM174.246 176.093c-9.221 0-17.568-1.666-25.04-4.997-7.472-3.332-13.434-8.726-17.885-16.182-4.451-7.456-6.677-17.371-6.677-29.746V51.636c0-12.374 2.226-22.29 6.677-29.746 4.451-7.456 10.334-12.85 17.647-16.181C156.44 2.377 164.866.71 174.246.71c9.379 0 17.805 1.666 25.277 4.998 7.472 3.331 13.434 8.725 17.886 16.181 4.451 7.457 6.677 17.372 6.677 29.746v73.532c0 12.375-2.226 22.29-6.677 29.746-4.452 7.456-10.414 12.85-17.886 16.182-7.472 3.331-15.898 4.997-25.277 4.997Zm0-14.516c10.651 0 18.918-2.935 24.8-8.805 6.042-5.869 9.062-15.071 9.062-27.604V51.636c0-12.533-3.02-21.734-9.062-27.604-5.882-5.87-14.149-8.805-24.8-8.805-10.652 0-18.919 2.935-24.801 8.805-5.883 5.87-8.824 15.071-8.824 27.604v73.532c0 12.533 2.941 21.735 8.824 27.604 5.882 5.87 14.149 8.805 24.801 8.805ZM301.763 176.093c-2.066 0-4.054-.476-5.961-1.428-1.749-.951-2.862-2.379-3.339-4.283L245.246 9.04c-.159-.476-.238-1.031-.238-1.666 0-1.427.477-2.617 1.43-3.57.954-.951 2.147-1.665 3.578-2.14 1.43-.635 2.782-.953 4.053-.953 1.431 0 2.783.397 4.054 1.19 1.272.635 2.067 1.587 2.385 2.856l41.255 146.112 23.609-88.762c.636-2.063 1.749-3.49 3.338-4.284 1.59-.793 3.339-1.19 5.247-1.19s3.577.397 5.008 1.19c1.43.794 2.384 2.221 2.861 4.284l24.086 88.762L406.928 4.757c.477-1.27 1.272-2.221 2.385-2.856 1.272-.793 2.623-1.19 4.054-1.19 1.59 0 3.021.318 4.293.952a9.277 9.277 0 0 1 3.338 2.142c.954.952 1.431 2.142 1.431 3.57 0 .634-.08 1.19-.239 1.665l-46.74 161.342c-.635 1.904-1.828 3.332-3.577 4.283-1.748.952-3.736 1.428-5.961 1.428-2.067 0-4.054-.476-5.962-1.428-1.749-.951-2.862-2.379-3.339-4.283l-22.654-84.003-22.655 84.003c-.477 1.904-1.669 3.332-3.577 4.283-1.749.952-3.736 1.428-5.962 1.428Z"/>
      <path d="M463.137 176.093c-2.066 0-4.054-.476-5.961-1.428-1.749-.951-2.862-2.379-3.339-4.283L406.62 9.04c-.159-.476-.238-1.031-.238-1.666 0-1.427.477-2.617 1.431-3.57.953-.951 2.146-1.665 3.577-2.14 1.43-.635 2.782-.953 4.054-.953 1.43 0 2.782.397 4.054 1.19 1.271.635 2.066 1.587 2.384 2.856l41.255 146.112 23.609-88.762c.636-2.063 1.749-3.49 3.339-4.284 1.589-.793 3.338-1.19 5.246-1.19 1.908 0 3.577.397 5.008 1.19 1.43.794 2.384 2.221 2.861 4.284l24.086 88.762L568.303 4.757c.476-1.27 1.271-2.221 2.384-2.856 1.272-.793 2.623-1.19 4.054-1.19 1.59 0 3.021.318 4.293.952a9.277 9.277 0 0 1 3.338 2.142c.954.952 1.431 2.142 1.431 3.57 0 .634-.079 1.19-.238 1.665l-46.74 161.342c-.636 1.904-1.829 3.332-3.578 4.283-1.748.952-3.736 1.428-5.961 1.428-2.067 0-4.054-.476-5.962-1.428-1.749-.951-2.862-2.379-3.339-4.283l-22.654-84.003-22.655 84.003c-.477 1.904-1.669 3.332-3.577 4.283-1.749.952-3.736 1.428-5.962 1.428Z"/>
      <path d="M624.53 176.127c-2.066 0-4.054-.476-5.962-1.428-1.748-.951-2.861-2.379-3.338-4.283L568.013 9.074c-.159-.476-.239-1.031-.239-1.666 0-1.427.477-2.617 1.431-3.57.954-.951 2.146-1.665 3.577-2.14 1.431-.635 2.782-.953 4.054-.953 1.431 0 2.782.397 4.054 1.19 1.272.635 2.067 1.587 2.385 2.856l41.255 146.112 23.609-88.762c.636-2.063 1.748-3.49 3.338-4.284 1.59-.793 3.339-1.19 5.247-1.19 1.907 0 3.577.397 5.007 1.19 1.431.794 2.385 2.221 2.862 4.284l24.085 88.762L729.695 4.791c.477-1.27 1.272-2.221 2.385-2.856 1.272-.793 2.623-1.19 4.054-1.19 1.59 0 3.021.318 4.292.952a9.273 9.273 0 0 1 3.339 2.142c.954.952 1.431 2.142 1.431 3.57 0 .634-.08 1.19-.239 1.665l-46.74 161.342c-.636 1.904-1.828 3.332-3.577 4.283-1.749.952-3.736 1.428-5.962 1.428-2.066 0-4.053-.476-5.961-1.428-1.749-.951-2.862-2.379-3.339-4.283l-22.654-84.002-22.655 84.002c-.477 1.904-1.669 3.332-3.577 4.283-1.749.952-3.736 1.428-5.962 1.428ZM807.479 176.365c-10.175 0-18.918-1.507-26.231-4.521-7.314-3.173-12.957-6.743-16.932-10.709-3.815-4.124-5.723-7.615-5.723-10.47 0-1.269.318-2.618.954-4.046.795-1.428 1.749-2.538 2.861-3.331 1.113-.952 2.226-1.428 3.339-1.428 1.59 0 3.18 1.031 4.769 3.094 1.749 1.903 3.975 4.204 6.678 6.901 2.861 2.538 6.597 4.838 11.208 6.901 4.61 1.903 10.651 2.855 18.123 2.855 7.472 0 13.832-1.19 19.078-3.569 5.246-2.539 9.3-6.187 12.162-10.947 2.861-4.918 4.292-11.026 4.292-18.323 0-7.615-1.431-13.723-4.292-18.324-2.862-4.6-6.677-8.408-11.447-11.422-4.61-3.014-9.697-5.553-15.262-7.615a1189.818 1189.818 0 0 1-16.931-6.425c-5.564-2.221-10.731-4.918-15.501-8.091-4.769-3.332-8.585-7.615-11.446-12.85-2.862-5.394-4.293-12.216-4.293-20.466 0-8.566 1.59-15.626 4.77-21.179 3.179-5.711 7.233-10.153 12.162-13.326a51.306 51.306 0 0 1 16.454-6.663C802.153.983 807.877.269 813.441.269c4.451 0 8.982.397 13.593 1.19 4.769.635 9.141 1.587 13.115 2.856 3.975 1.269 7.155 2.855 9.539 4.76 2.544 1.744 3.816 3.727 3.816 5.948 0 .952-.318 2.142-.954 3.57-.477 1.269-1.192 2.459-2.146 3.57-.954 1.11-2.226 1.665-3.816 1.665-1.431 0-3.418-.714-5.962-2.142-2.543-1.586-6.041-3.093-10.492-4.521-4.293-1.586-9.936-2.38-16.932-2.38a58.96 58.96 0 0 0-16.692 2.38c-5.247 1.586-9.539 4.442-12.878 8.567-3.338 3.966-5.008 9.44-5.008 16.42 0 6.345 1.431 11.501 4.293 15.467 3.02 3.808 6.836 6.901 11.446 9.281 4.77 2.38 9.937 4.6 15.501 6.663a182.886 182.886 0 0 1 16.693 6.663c5.723 2.38 10.89 5.474 15.5 9.281 4.77 3.649 8.585 8.488 11.447 14.516 2.861 6.029 4.292 13.802 4.292 23.321 0 11.264-2.146 20.544-6.438 27.842-4.293 7.139-10.255 12.454-17.886 15.944-7.472 3.49-16.136 5.235-25.993 5.235ZM.796 7.75a6.708 6.708 0 0 1 6.709-6.708H252.82a6.708 6.708 0 0 1 0 13.417H7.505A6.708 6.708 0 0 1 .796 7.751Z"/>
      <path d="M732.584 7.75a6.709 6.709 0 0 1 6.709-6.708h65.316a6.708 6.708 0 0 1 0 13.417h-65.316a6.709 6.709 0 0 1-6.709-6.708Z"/>
    </svg>
    <div class="text-right text-white text-xs">
      <div class="space-x-4 flex">
        <div>
          <span id="info-generation">
            0
          </span>
          <span>
            世代
          </span>
        </div>
        <div>
          <span id="info-life-cell">
            0
          </span>
          <span>
            細胞
          </span>
        </div>
      </div>
      <div class="space-x-4">
        <span id="game__panel-button-1" class="pointer-events-auto cursor-pointer hover:text-teal-500">
          ∞
        </span>
        <span id="game__panel-button-2" class="pointer-events-auto cursor-pointer hover:text-teal-500">
          リセット
        </span>
      </div>
    </div>
  </div>
  <div id="game" class="game fixed top-0 left-0 z-50 w-full h-full pointer-events-none">
    <canvas id="game__world" class="game__world" />
  </div>
</template>
<script>
  export default {
    mounted() {

      var GameOfLife = (function() {
        function GameOfLife(config) {
          this.canvas = config.canvas
          this.unitSize = config.unitSize
          this.columns = config.columns
          this.lines = config.lines
          this.drawRate = config.drawRate
          this.gridSize = config.gridSize

          this.width = this.canvas.width = this.unitSize * this.columns
          this.height = this.canvas.height = this.unitSize * this.lines

          this.ctx = this.canvas.getContext('2d')
          this.infoPanel = config.infoPanel
          this.infoGeneration = config.infoGeneration
          this.infoLifeCell = config.infoLifeCell

          this.oldState = []
          this.newState = []
          this.useState = []

          this.gameOn = false
          this.counter = 0
          this.lifeCell = 0

          this.gameBox = config.gameBox
          this.gameBoxSize = {w: this.gameBox.clientWidth, h: this.gameBox.clientHeight}
        }

        GameOfLife.prototype.init = function() {
          for(var i = 0; i < this.columns; i++) {
            this.oldState[i] = []
            this.newState[i] = []
            this.useState[i] = []

            for(var j = 0; j < this.lines; j++) {
              this.newState[i][j] = false
              this.oldState[i][j] = false
              this.useState[i][j] = false
            }
          }
        }

        GameOfLife.prototype.randomDraft = function() {
          for(var i = 0; i < this.columns; i++) {
            this.oldState[i] = []
            this.newState[i] = []
            this.useState[i] = []

            for(var j = 0; j < this.lines; j++) {
              var result = Math.random() < .075

              this.newState[i][j] = result
              this.oldState[i][j] = result
              this.useState[i][j] = false
            }
          }

          this.update()
          this.counter = 0
        }

        GameOfLife.prototype.update = function() {
          for(var i = 0; i < this.columns; i++) {
            for(var j = 0; j < this.lines; j++) {
              this.newState[i][j] = this.updateState( i, j )
            }
          }

          for(var i = 0; i < this.newState.length; i++) {
            for(var j = 0; j < this.newState[i].length; j++) {
              this.oldState[i][j] = this.newState[i][j] ? true : false
            }
          }

          this.counter++
        }

        GameOfLife.prototype.updateState = function(i, j) {
          var adyacentAlive = 0,
            iMinus = i - 1 >= 0,
            iPlus = i + 1 < this.columns,
            jMinus = j - 1 >= 0,
            jPlus = j + 1 < this.lines

          if(iMinus && jMinus && this.oldState[i-1][j-1]) { adyacentAlive++ }
          if(iMinus && this.oldState[i-1][j]) { adyacentAlive++ }
          if(iMinus && jPlus && this.oldState[i-1][j+1]) { adyacentAlive++ }
          if(iPlus && jMinus && this.oldState[i+1][j-1]) { adyacentAlive++ }

          if(iPlus && this.oldState[i+1][j]) { adyacentAlive++ }
          if(iPlus && jPlus && this.oldState[i+1][j+1]) { adyacentAlive++ }
          if(jMinus && this.oldState[i][j-1]) { adyacentAlive++ }
          if(jPlus && this.oldState[i][j+1]) { adyacentAlive++ }

          return (this.oldState[i][j] && adyacentAlive === 2) || (this.oldState[i][j] && adyacentAlive === 3) || (!this.oldState[i][j] && adyacentAlive === 3)
        }

        GameOfLife.prototype.draw = function() {
          this.lifeCell = 0
          this.ctx.clearRect(0, 0, this.width, this.height)

          this.drawGrid()

          for(var i = 0; i < this.columns; i++) {
            for(var j = 0; j < this.lines; j++) {
              if(this.useState[i][j]) {
                this.ctx.beginPath()
                this.ctx.fillStyle = 'rgba(0,0,0,.15)'
                this.ctx.fillRect(i*this.unitSize, j*this.unitSize, this.unitSize, this.unitSize)
                this.ctx.closePath()
              }
            }
          }

          for(var i = 0; i < this.columns; i++) {
            for(var j = 0; j < this.lines; j++) {
              if(this.newState[i][j]) {
                this.lifeCell++
                this.useState[i][j] = true

                this.ctx.beginPath()
                this.ctx.fillStyle = 'rgba(0,0,0,.5)'
                this.ctx.fillRect(i*this.unitSize, j*this.unitSize, this.unitSize, this.unitSize)
                this.ctx.closePath()
              }
            }
          }
        }

        GameOfLife.prototype.addUnit = function(x, y) {
          var i = Math.floor(x/this.unitSize)
          var j = Math.floor(y/this.unitSize)

          this.newState[i][j] = !this.newState[i][j]
          this.oldState[i][j] = !this.oldState[i][j]
        }

        GameOfLife.prototype.gg = function() {
          this.gameOn = !this.gameOn
        }

        GameOfLife.prototype.start = function() {
          this.init()
          this.draw()

          setInterval(this.tick, this.drawRate, this)
        }

        GameOfLife.prototype.tick = function(self) {
          if(self.gameOn) self.update()

          self.infoGeneration.innerHTML = self.getGeneration()
          self.infoLifeCell.innerHTML = self.getLifeCell()

          self.draw()
          self.grid = self.state
        }

        GameOfLife.prototype.getWorldSize = function() {
          return {
            w: this.width,
            h: this.height
          }
        }

        GameOfLife.prototype.getGeneration = function() {
          return this.counter
        }

        GameOfLife.prototype.getLifeCell = function() {
          return this.lifeCell
        }

        GameOfLife.prototype.drawGrid = function() {
          var hLines = this.height/this.unitSize/this.gridSize
          var wLines = this.width/this.unitSize/this.gridSize

          for(var i = 0; i < hLines; i++) {
            this.ctx.beginPath()
            this.ctx.moveTo(0, i*this.gridSize*this.unitSize-.5)
            this.ctx.lineTo(this.width, i*this.gridSize*this.unitSize-.5)

            if(i%5) {
                this.ctx.strokeStyle = 'rgba(0,0,0,.1)'
            } else {
                this.ctx.strokeStyle = 'rgba(0,0,0,.3)'
            }

            this.ctx.stroke()
            this.ctx.closePath()
          }

          for(var i = 0; i < wLines; i++) {
            this.ctx.beginPath()
            this.ctx.moveTo(i*this.gridSize*this.unitSize-.5, 0)
            this.ctx.lineTo(i*this.gridSize*this.unitSize-.5, this.height)

            if(i%5) {
              this.ctx.strokeStyle = 'rgba(0,0,0,.1)'
            } else {
              this.ctx.strokeStyle = 'rgba(0,0,0,.3)'
            }

            this.ctx.stroke()
            this.ctx.closePath()
          }
        }

        GameOfLife.prototype.reset = function() {
          this.init()
          this.gameOn = false
          this.counter = 0
          this.lifeCell = 0
        }

        return GameOfLife
      })()

      var c = document.getElementById('game__world')
      var startButton = document.getElementById('game__panel-button-1')
      var resetWorld = document.getElementById('game__panel-button-2')
      var infoPanel = document.getElementsByClassName('game__info')[0]
      var infoGeneration = document.getElementById('info-generation')
      var infoLifeCell = document.getElementById('info-life-cell')
      var gameBox = document.getElementById('game')

      var gameOfLife = new GameOfLife({
        canvas: c,
        unitSize: 10,
        columns: 200,
        lines: 120,
        drawRate: 1000/10,
        gridSize: 3,
        infoPanel: infoPanel,
        infoGeneration: infoGeneration,
        infoLifeCell: infoLifeCell,
        gameBox: gameBox
      })

      gameOfLife.start()
      gameOfLife.randomDraft()
      gameOfLife.gg()

      c.addEventListener('click', function(e) {
        gameOfLife.addUnit(e.offsetX, e.offsetY)
      })

      startButton.addEventListener('click', function() {
        gameOfLife.gg()
      })

      resetWorld.addEventListener('click', function() {
        gameOfLife.reset()
        gameOfLife.randomDraft()
        gameOfLife.gg()
      })
    }
  }
</script>

